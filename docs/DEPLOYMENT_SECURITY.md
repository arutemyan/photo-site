# デプロイメントセキュリティガイド - 公開リポジトリとセルフホスティング

このドキュメントは、photo-site を公開リポジトリとして公開し、不特定多数のユーザーが自身の環境でホスティングする際のセキュリティガイドラインを提供します。

## 目次

1. [公開リポジトリ化の適性評価](#公開リポジトリ化の適性評価)
2. [セルフホスティングでの主なリスク](#セルフホスティングでの主なリスク)
3. [安全にセルフホスティングするための対策](#安全にセルフホスティングするための対策)
4. [リポジトリ公開前のチェックリスト](#リポジトリ公開前のチェックリスト)
5. [ユーザーへの推奨事項](#ユーザーへの推奨事項)
6. [よくある質問](#よくある質問)

---

## 公開リポジトリ化の適性評価

### ✅ 公開可能な理由

このアプリケーションは、以下の理由から**公開リポジトリとして適切**です：

1. **機密情報の不在**
   - ハードコードされた認証情報なし
   - API キーやシークレットなし
   - デフォルト設定に空のパスワード（ユーザーが設定）

2. **セキュアな設計**
   - SQLインジェクション対策（Prepared Statements）
   - XSS対策（適切なエスケープ）
   - CSRF対策（トークンベース）
   - セッション管理（セキュアな設定）
   - レート制限（ブルートフォース対策）

3. **設定の分離**
   - デフォルト設定: `config/config.default.php`（公開可能）
   - ローカル設定: `config/config.local.php`（.gitignore に含まれる）
   - 環境固有の機密情報は .gitignore で除外

4. **明確なセキュリティドキュメント**
   - `docs/SECURITY.md`: 包括的なセキュリティガイド
   - `docs/SECURITY_REVIEW.md`: セキュリティ監査結果
   - 本番環境での推奨設定が明示されている

### ⚠️ 注意が必要な点

1. **デフォルト設定の管理画面パス**
   - `config/config.default.php` の `admin.path` がデフォルトで `'admin'`
   - 公開後は推測されやすいため、ドキュメントで変更を強く推奨する必要がある

2. **初期セットアップ**
   - セットアップページ（`/setup/`）が存在
   - セットアップ完了後は削除が必要（ドキュメント化が必要）

3. **CORS設定**
   - デフォルトで `allowed_origins: ['*']`（開発環境向け）
   - 本番環境では具体的なドメインを指定する必要がある

---

## セルフホスティングでの主なリスク

### リスク1: 不適切な設定によるセキュリティホール

**シナリオ**: ユーザーがデフォルト設定のまま本番環境にデプロイ

**リスク内容**:
- 管理画面のパスが `/admin` のまま（推測されやすい）
- CORS が `*` のまま（すべてのオリジンを許可）
- HTTPで運用（セッションクッキーが盗聴可能）
- セットアップページが残ったまま（再実行可能）

**影響度**: 高

### リスク2: 弱いパスワードの使用

**シナリオ**: ユーザーが初期セットアップ時に弱いパスワードを設定

**リスク内容**:
- ブルートフォース攻撃の対象になる
- 辞書攻撃で突破される可能性

**影響度**: 中（レート制限である程度緩和）

### リスク3: ファイルパーミッションの不備

**シナリオ**: データベースファイルや設定ファイルのパーミッションが不適切

**リスク内容**:
- データベースファイルが読み取り可能（SQLite使用時）
- 設定ファイルが読み取り可能（パスワード等が漏洩）
- セッションキーファイルが読み取り可能

**影響度**: 高

### リスク4: 古いバージョンの使用

**シナリオ**: ユーザーがセキュリティアップデートを適用しない

**リスク内容**:
- 発見された脆弱性が放置される
- 既知の攻撃手法で侵害される可能性

**影響度**: 中～高

---

## 安全にセルフホスティングするための対策

このセクションでは、リポジトリ提供者（あなた）とユーザー（セルフホスティングする人）の両方が実施すべき対策を説明します。

### 提供者側で実施すべき対策

#### 1. 包括的なドキュメントの提供 ✅ 実施済み

- [x] セキュリティガイド（`docs/SECURITY.md`）
- [x] セキュリティレビュー結果（`docs/SECURITY_REVIEW.md`）
- [ ] **追加推奨**: デプロイメントガイド（本ドキュメント）
- [ ] **追加推奨**: README に警告セクションを追加

#### 2. セキュアなデフォルト設定

現在のデフォルト設定を確認：

```php
// config/config.default.php
'admin' => [
    'path' => 'admin',  // ⚠️ 推測されやすい
],

'security' => [
    'https' => [
        'force' => false,  // ⚠️ 本番環境では true が推奨
    ],
    'session' => [
        'force_secure_cookie' => false,  // ⚠️ 本番環境では true が推奨
    ],
    'cors' => [
        'allowed_origins' => ['*'],  // ⚠️ 本番環境では具体的なドメインが推奨
    ],
],
```

**推奨事項**:
- README に「本番環境では config.local.php で上書きが必須」と明記
- セットアップ時に警告メッセージを表示
- サンプル設定ファイル（`config/config.local.example.php`）を提供

#### 3. セットアップ後の自動削除 

**推奨実装**:
```php
// public/setup/index.php の最後に追加
// セットアップ完了後、setup ディレクトリを削除することを推奨
echo "⚠️ セキュリティのため、セットアップ完了後は setup/ ディレクトリを削除してください\n";
echo "コマンド: rm -rf public/setup/\n";
```

#### 4. セキュリティチェックスクリプトの提供

**推奨**: セキュリティ設定を検証するスクリプトを追加

```bash
# scripts/security_check.php
php scripts/security_check.php
```

これにより以下をチェック：
- [ ] 管理画面パスがデフォルトでないか
- [ ] HTTPSが強制されているか
- [ ] CORS設定が適切か
- [ ] セットアップディレクトリが削除されているか
- [ ] ファイルパーミッションが適切か

#### 5. GitHub Security Features の有効化

- [x] Dependabot を有効化（依存パッケージの脆弱性スキャン）
- [ ] **推奨**: GitHub Security Advisories を有効化
- [ ] **推奨**: SECURITY.md に脆弱性報告先を明記

### ユーザー側（セルフホスティング者）が実施すべき対策

#### 必須対策（デプロイ前）

1. **config.local.php の作成**

```php
<?php
// config/config.local.php
return [
    'app' => [
        'environment' => 'production',
    ],
    
    'admin' => [
        // 推測されにくいランダムな文字列に変更
        'path' => 'xK9mP2nQ7_admin_' . bin2hex(random_bytes(8)),
    ],
    
    'security' => [
        'https' => [
            'force' => true,
            'hsts_enabled' => true,
        ],
        'session' => [
            'force_secure_cookie' => true,
        ],
        'cors' => [
            'allowed_origins' => [
                'https://yourdomain.com',
            ],
            'allow_credentials' => true,
        ],
        'csp' => [
            'enabled' => true,
        ],
    ],
    
    'database' => [
        // 本番環境では MySQL/PostgreSQL を推奨
        'driver' => 'mysql',
        'mysql' => [
            'host' => getenv('DB_HOST') ?: 'localhost',
            'database' => getenv('DB_NAME') ?: 'photo_site',
            'username' => getenv('DB_USER') ?: 'photo_user',
            'password' => getenv('DB_PASS'),
        ],
    ],
];
```

2. **環境変数の設定**

```bash
# .env（このファイルも .gitignore に含める）
DB_HOST=localhost
DB_NAME=photo_site_production
DB_USER=photo_user
DB_PASS=STRONG_RANDOM_PASSWORD_HERE
```

3. **ファイルパーミッションの設定**

```bash
# データディレクトリ
chmod 700 data/
chmod 600 data/*.db

# 設定ファイル
chmod 600 config/config.php
chmod 600 config/config.local.php
chmod 600 .env

# セッションキー
chmod 700 config/session_keys/
chmod 600 config/session_keys/*.php

# アップロードディレクトリ
chmod 755 public/uploads/
chmod 644 public/uploads/*/*.webp
```

4. **セットアップディレクトリの削除**

```bash
rm -rf public/setup/
```

5. **強力な管理者パスワードの設定**

- 最低12文字
- 大文字・小文字・数字・記号を含む
- パスワードマネージャーの使用を推奨

#### 推奨対策（運用時）

1. **定期的なバックアップ**
   - データベースの定期バックアップ
   - アップロードファイルのバックアップ

2. **セキュリティアップデートの適用**
   - リポジトリの更新を定期的に確認
   - 依存パッケージの更新（`composer update`）

3. **ログの監視**
   - `logs/security.log` を定期的に確認
   - 不審なアクセスの検出

4. **ファイアウォールの設定**
   - 管理画面へのアクセスをIP制限
   - 不要なポートの閉鎖

5. **SSL/TLS証明書の使用**
   - Let's Encrypt などで無料の証明書を取得
   - 自動更新の設定

---

## リポジトリ公開前のチェックリスト

### コードレベル

- [x] ハードコードされた認証情報がないか確認
- [x] APIキーやシークレットがないか確認
- [x] .gitignore に機密ファイルが含まれているか確認
- [x] デフォルトのパスワードが空になっているか確認
- [x] セキュリティ脆弱性のスキャン（SQLインジェクション等）

### ドキュメント

- [x] README にセキュリティ警告を追加
- [x] インストールガイドの作成
- [x] セキュリティガイドの作成（`docs/SECURITY.md`）
- [ ] **推奨**: デプロイメントガイドの追加（本ドキュメント）
- [ ] **推奨**: サンプル設定ファイルの提供

### GitHub設定

- [ ] SECURITY.md に脆弱性報告先を明記
- [ ] GitHub Security Advisories の有効化
- [ ] Dependabot の有効化
- [ ] Issue テンプレートの作成
- [ ] Pull Request テンプレートの作成

### リリース準備

- [ ] セキュリティチェックスクリプトの作成
- [ ] セットアップ完了後の警告メッセージ追加
- [ ] LICENSE ファイルの確認（MIT）
- [ ] CONTRIBUTING.md の作成

---

## ユーザーへの推奨事項

### README に追加すべき警告セクション

```markdown
## ⚠️ セキュリティに関する重要な注意事項

本番環境にデプロイする前に、以下を**必ず**実施してください：

### 必須事項

1. **config.local.php の作成**
   - `config/config.default.php` をコピーして `config/config.local.php` を作成
   - 管理画面のパスを推測されにくい文字列に変更
   - HTTPS を強制（`force: true`）
   - CORS の `allowed_origins` を具体的なドメインに設定

2. **強力なパスワードの設定**
   - 最低12文字、大文字・小文字・数字・記号を含む
   - パスワードマネージャーの使用を推奨

3. **セットアップディレクトリの削除**
   - セットアップ完了後、`public/setup/` を削除
   - `rm -rf public/setup/`

4. **ファイルパーミッションの設定**
   - データベース: `chmod 600 data/*.db`
   - 設定ファイル: `chmod 600 config/*.php`
   - セッションキー: `chmod 700 config/session_keys/`

5. **SSL/TLS証明書の設定**
   - HTTPS での運用が必須

### 推奨事項

- ファイアウォールで管理画面へのアクセスをIP制限
- 定期的なバックアップの実施
- セキュリティログの監視
- 定期的なアップデートの適用

詳細は `docs/SECURITY.md` および `docs/DEPLOYMENT_SECURITY.md` を参照してください。
```

### FAQ 形式での説明

**Q: デフォルト設定のままデプロイしても大丈夫ですか？**

A: **いいえ、絶対にしないでください。** デフォルト設定は開発環境向けです。本番環境では以下が必須です：
- 管理画面パスの変更
- HTTPS の強制
- CORS 設定の制限
- セットアップディレクトリの削除

**Q: どのようなパスワードポリシーを推奨しますか？**

A: 以下を推奨します：
- 最低12文字（推奨は16文字以上）
- 大文字・小文字・数字・記号をすべて含む
- パスワードマネージャーで生成されたランダムな文字列

**Q: SQLite と MySQL/PostgreSQL、どちらを使うべきですか？**

A: 本番環境では **MySQL または PostgreSQL を強く推奨** します。理由：
- SQLite はファイルベースのため、パーミッション設定が重要
- 同時アクセスのスケーラビリティ
- より高度なセキュリティ機能

**Q: セキュリティアップデートはどのように知ることができますか？**

A: 以下の方法があります：
- GitHub の "Watch" 機能で "Releases only" を選択
- GitHub Security Advisories を有効化
- RSS フィードを購読

---

## よくある質問

### Q1: このアプリケーションは商用利用可能ですか？

**A**: はい、MIT ライセンスのため商用利用可能です。ただし、セキュリティ対策は自己責任で実施してください。

### Q2: 共有ホスティング環境で使用できますか？

**A**: 可能ですが、以下の条件を満たす必要があります：
- PHP 8.1以上
- Composer が使用可能
- データベース（SQLite、MySQL、PostgreSQL のいずれか）
- ファイルパーミッションの設定が可能
- HTTPS が利用可能

### Q3: 複数サイトで同じコードベースを使用できますか？

**A**: はい、可能です。各サイトごとに：
- 別々の `config/config.local.php` を作成
- 別々のデータベースを使用
- 別々のアップロードディレクトリを使用

### Q4: セキュリティ上の問題を発見した場合はどうすればいいですか？

**A**: 公開の Issue ではなく、以下の方法で報告してください：
- GitHub Security Advisories（有効化後）
- プロジェクトメンテナーへの直接連絡
- 詳細は `SECURITY.md` を参照

---

## まとめ

### ✅ 公開可能な理由

1. **セキュアな実装**: 主要な脆弱性対策が実装済み
2. **機密情報の不在**: ハードコードされた認証情報なし
3. **設定の分離**: 環境固有の設定は除外済み
4. **明確なドキュメント**: セキュリティガイドが充実

### ⚠️ 推奨する追加対策

1. **README への警告追加**: 本番デプロイ前の必須事項を明記
2. **サンプル設定の提供**: `config.local.example.php` の作成
3. **セキュリティチェックスクリプト**: 自動検証ツールの提供
4. **セットアップ後の警告**: ディレクトリ削除の促進

### 📝 ユーザーへの期待

セルフホスティングするユーザーには、以下を期待します：
- ドキュメントの熟読
- 推奨設定の適用
- 定期的なアップデート
- セキュリティログの監視

---

**結論**: このリポジトリは、適切なドキュメントと警告を追加することで、**公開リポジトリとして安全に公開可能**です。ユーザーが推奨事項に従う限り、セルフホスティングも安全に行えます。

---

**最終更新**: 2025-11-09  
**レビュー担当**: GitHub Copilot
