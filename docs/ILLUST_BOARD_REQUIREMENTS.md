# お絵描き機能要件仕様

## 概要
昔のお絵描き掲示板機能を再現したWebベースのイラスト作成ツール。レスポンシブ対応で、PC・スマホ両対応。管理機能のみで投稿・編集可能。

## 機能要件

### 基本機能
- **レスポンシブ対応**: スマホ・PC問わずにお絵描き可能
- **キャンバスサイズ**: ユーザー設定可能（最大4096x4096px、設定ファイル参照）
- **保存形式**: PNG/JPG等標準画像形式

### カラーパレット
- **16色パレット**: 基本16色
- **拡張色選択**: カラーピッカーで任意色選択可能
- **プリセットパレット**: 複数プリセット提供
- **スポイトツール**: キャンバスから色取得しパレット追加

### 描画ツール
- **ペン**: 基本描画ツール
- **消しゴム**: 消去ツール
- **アンチエイリアス**: ペン・消しゴムでオプション（トグル制御）
- **ツール設定**: ペン・消しゴムそれぞれ独立した太さ設定

### レイヤー機能
- **レイヤー数**: 4枚固定
- **デフォルトレイヤー**: 背景、下書き、清書、着色
- **レイヤー管理**: 名前変更可能、可視性制御、順序変更

### タイムラプス機能
- **記録**: すべての操作を記録（ペン、消しゴム、レイヤー操作、設定変更）
- **容量制御**: 設定可能な容量上限（デフォルト50MB）、超過時は記録停止（既存記録は再生可能）
- **圧縮**: zlib圧縮
- **データ形式**: msgpack
- **再生**: 保存後メニューから再生、タイムラプス状態確認
- **完全再現**: タイムラプス再生で完成イラストと1:1一致

### 編集機能
- **選択ツール**: 矩形選択、切り取り貼り付け
- **視覚操作**: 拡大縮小（視覚的）、回転（視覚的）- 画像データ変更なし
- **画像編集**: 実際の画像回転・拡縮機能
- **Undo/Redo**: 操作履歴の取り消し・やり直し（最大50履歴保持、設定ファイル参照）

### 保存・読み込み
- **途中保存**: 作業途中保存
- **再開機能**: 保存データから続きから再開
- **ローカル保存**: PCローカルに一時データ保存・読み込み
- **サーバー保存**: サーバーに保存、続きから再開可能

### 管理・公開

## サーバー要件
- **PHP バージョン**: 8.0 以上推奨
- **拡張**:
  - PDO + SQLite (既存システムと互換)
  - Fileinfo (`finfo`) - MIME 検証用
  - zlib - タイムラプスの gzip 圧縮/解凍
  - msgpack (推奨) - タイムラプスの高速 pack/unpack に使用。無い場合は composer パッケージで代替可能だが性能/メモリに注意
  - gd (WebP 対応) または imagick - サムネイルを WebP に変換するために必要
  - その他: openssl（もし将来的に署名や暗号化を行う場合）

## 運用上の注意
- タイムラプスや Undo 履歴はメモリ/ディスクを消費するため、サーバのメモリ・ディスク容量に余裕があることを確認してください。
- **管理インターフェース**: `public/admin/paint/` 以下に専用PHPファイル
- **API**: `public/admin/paint/api/` 以下
- **公開ビュー**: `public/paintview.php` で一覧表示、オーバーレイで画像・タイムラプス再生
- **過去作品確認**: `public/admin/paint` から確認・タイムラプス再生

### セキュリティ・統合
- **セッション管理**: 既存 `public/admin` 機能利用
- **セキュリティ**: 既存機能のセキュリティ対策利用
- **依存分離**: 既存機能と分離、実装後統合検討

## データ構造

### タイムラプスデータ形式
- **形式**: msgpack + zlib圧縮
- **構造**: 配列 `[action_type: {data}]`
- **action_type**:
  - 1: ペン - 始点、終点、色、太さ、アンチエイリアス
  - 2: 消しゴム - 始点、終点、太さ、アンチエイリアス
  - 3: レイヤー操作 - レイヤーID、操作タイプ（作成/削除/順序変更/名前変更/可視性）
  - 4: 設定変更 - ツールタイプ、設定項目（太さ等）
  - 5: 選択操作 - 矩形座標、操作タイプ（切り取り/貼り付け）
  - 6: キャンバス操作 - 拡大縮小率、回転角度（視覚的）
  - 7: 画像編集 - 回転角度、拡縮率（実際のデータ変更）

### ストレージ
- **画像データ**: サーバー `uploads/` 以下
- **内部データ**: サーバー data/ 以下。こっちはタイムラプスなど
- **タイムラプスデータ**: 圧縮msgpackファイル
- **メタデータ**: DBに作品情報、レイヤー情報等

## 非機能要件
- **パフォーマンス**: レイヤー4枚でメモリ負荷考慮
- **ブラウザ互換**: モダンブラウザ対応
- **モバイル最適**: タッチ操作対応