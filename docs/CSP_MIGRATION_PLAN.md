# Content-Security-Policy (CSP) ç§»è¡Œè¨ˆç”»

**ä½œæˆæ—¥**: 2025-11-14  
**å¯¾è±¡**: PixuGallery ç®¡ç†ç”»é¢ãŠã‚ˆã³å…¬é–‹ãƒšãƒ¼ã‚¸  
**é–¢é€£Issue**: ç®¡ç†ç”»é¢ã®Content-Security-Policy(CSP)ã®ç§»è¡Œæ¤œè¨ï¼ˆunsafe-inline/unsafe-evalå»ƒæ­¢è¨ˆç”»ï¼‰

---

## 1. æ¦‚è¦ã¨ç›®çš„

### 1.1 èƒŒæ™¯

ç¾åœ¨ã®å®Ÿè£…ã§ã¯ã€Content-Security-Policy (CSP) ã®è¨­å®šã§ä»¥ä¸‹ã®å•é¡Œç‚¹ãŒã‚ã‚Šã¾ã™ï¼š

- **ç®¡ç†ç”»é¢**: `'unsafe-inline'` ã¨ `'unsafe-eval'` ã‚’è¨±å¯
- **å…¬é–‹ãƒšãƒ¼ã‚¸**: `'unsafe-inline'` ã‚’è¨±å¯

ã“ã‚Œã‚‰ã®è¨­å®šã¯ã€XSS (Cross-Site Scripting) æ”»æ’ƒã®ãƒªã‚¹ã‚¯ã‚’é«˜ã‚ã¾ã™ã€‚docs/SECURITY_REVIEW.md ã§ã‚‚æ”¹å–„ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

### 1.2 ç›®çš„

- `'unsafe-inline'` ãŠã‚ˆã³ `'unsafe-eval'` ã‚’æ®µéšçš„ã«å»ƒæ­¢
- nonce ã¾ãŸã¯ hash ãƒ™ãƒ¼ã‚¹ã®å®‰å…¨ãª CSP ã«ç§»è¡Œ
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã¤ã¤ã€æ—¢å­˜æ©Ÿèƒ½ã‚’ç¶­æŒ

---

## 2. ç¾çŠ¶åˆ†æ

### 2.1 ç¾åœ¨ã® CSP è¨­å®š

**å ´æ‰€**: `src/Security/SecurityUtil.php` (line 88-109)

#### ç®¡ç†ç”»é¢ (isAdmin = true)
```php
script-src 'self' 'unsafe-inline' 'unsafe-eval' cdn.jsdelivr.net code.jquery.com;
style-src 'self' 'unsafe-inline' cdn.jsdelivr.net fonts.googleapis.com;
```

#### å…¬é–‹ãƒšãƒ¼ã‚¸ (isAdmin = false)
```php
script-src 'self' 'unsafe-inline' cdn.jsdelivr.net code.jquery.com;
style-src 'self' 'unsafe-inline' cdn.jsdelivr.net fonts.googleapis.com;
```

### 2.2 inline script ã®ä½¿ç”¨ç®‡æ‰€

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œç•ªå· | å†…å®¹ | å„ªå…ˆåº¦ | ç§»è¡Œé›£æ˜“åº¦ |
|---------|-------|------|--------|-----------|
| `public/admin/index.php` | 1010-1013 | ADMIN_PATH å®šæ•° | é«˜ | ä½ |
| `public/admin/paint/index.php` | 527 | CSRF_TOKEN | é«˜ | ä½ |
| `public/admin/paint/index.php` | 529-532 | PAINT_BASE_URL å®šæ•° | é«˜ | ä½ |
| `public/admin/paint/index.php` | 534-560 | Worker constructor shim | ä¸­ | ä¸­ |
| `public/index.php` | 126-132 | è¨­å®šå€¤ (AGE_VERIFICATIONç­‰) | é«˜ | ä½ |
| `public/detail.php` | - | è¨­å®šå€¤ã®åŸ‹ã‚è¾¼ã¿ | é«˜ | ä½ |
| `public/paint/index.php` | - | è¨­å®šå€¤ã®åŸ‹ã‚è¾¼ã¿ | é«˜ | ä½ |
| `public/paint/detail.php` | - | è¨­å®šå€¤ã®åŸ‹ã‚è¾¼ã¿ | é«˜ | ä½ |

### 2.3 eval() ã®ä½¿ç”¨ç®‡æ‰€

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œç•ªå· | å†…å®¹ | ç›®çš„ | ä»£æ›¿æ–¹æ³• |
|---------|-------|------|------|---------|
| `public/admin/js/admin.js` | 565 | `eval(name)` | é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹ | ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒãƒƒãƒ—ã«ã‚ˆã‚‹å‚ç…§ |

### 2.4 inline style ã®ä½¿ç”¨ç®‡æ‰€

| ãƒ•ã‚¡ã‚¤ãƒ« | ç®‡æ‰€æ•° | å†…å®¹ |
|---------|-------|------|
| `public/admin/index.php` | 25ç®‡æ‰€ | styleå±æ€§ã«ã‚ˆã‚‹ç›´æ¥æŒ‡å®š |
| `public/admin/paint/index.php` | 26ç®‡æ‰€ | styleå±æ€§ã«ã‚ˆã‚‹ç›´æ¥æŒ‡å®š |
| `public/index.php` | - | PHP require ã«ã‚ˆã‚‹ style ãƒ–ãƒ­ãƒƒã‚¯ |

---

## 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯è©•ä¾¡

### 3.1 unsafe-inline ã®ãƒªã‚¹ã‚¯

**ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«**: ğŸ”´ é«˜

- XSSæ”»æ’ƒã«ã‚ˆã‚‹ä»»æ„ã®JavaScriptå®Ÿè¡Œã‚’è¨±å¯
- æ”»æ’ƒè€…ãŒ `<script>` ã‚¿ã‚°ã‚’æ³¨å…¥ã§ãã‚Œã°ã€å³åº§ã«å®Ÿè¡Œã•ã‚Œã‚‹
- CSP ã®ä¿è­·æ©Ÿèƒ½ãŒå¤§å¹…ã«ä½ä¸‹

### 3.2 unsafe-eval ã®ãƒªã‚¹ã‚¯

**ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ ä¸­

- `eval()`, `Function()`, `setTimeout(string)` ãªã©ã‚’è¨±å¯
- ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒã®ãƒªã‚¹ã‚¯
- ç¾åœ¨ã¯ç®¡ç†ç”»é¢ã®ã¿ã§ä½¿ç”¨ï¼ˆå½±éŸ¿ç¯„å›²ã¯é™å®šçš„ï¼‰

### 3.3 ç¾çŠ¶ã®è©•ä¾¡

| é …ç›® | ç®¡ç†ç”»é¢ | å…¬é–‹ãƒšãƒ¼ã‚¸ | å‚™è€ƒ |
|------|---------|----------|------|
| unsafe-inline (script) | âŒ ä½¿ç”¨ä¸­ | âŒ ä½¿ç”¨ä¸­ | é«˜ãƒªã‚¹ã‚¯ |
| unsafe-eval | âŒ ä½¿ç”¨ä¸­ | âœ… ä¸ä½¿ç”¨ | ä¸­ãƒªã‚¹ã‚¯ï¼ˆç®¡ç†ç”»é¢ã®ã¿ï¼‰ |
| å¤–éƒ¨CDN | âš ï¸ è¨±å¯ | âš ï¸ è¨±å¯ | SubResource Integrity (SRI) æ¨å¥¨ |

---

## 4. ç§»è¡Œæˆ¦ç•¥

### 4.1 æ®µéšçš„ç§»è¡Œã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

#### ãƒ•ã‚§ãƒ¼ã‚º 1: æº–å‚™ãƒ»è¨­è¨ˆ (æ¨å®š: 1-2é€±é–“)
- [ ] nonce ãƒ™ãƒ¼ã‚¹ CSP ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®è¨­è¨ˆ
- [ ] inline script ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«åŒ–ã™ã‚‹ãŸã‚ã®èª¿æŸ»
- [ ] ãƒ†ã‚¹ãƒˆç’°å¢ƒã®æ§‹ç¯‰
- [ ] ç§»è¡Œç®¡ç†è¡¨ã®ä½œæˆ

#### ãƒ•ã‚§ãƒ¼ã‚º 2: eval() ã®å»ƒæ­¢ (æ¨å®š: 3-5æ—¥)
- [ ] `public/admin/js/admin.js` ã® eval() ã‚’å‰Šé™¤
- [ ] ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒãƒƒãƒ—ã«ã‚ˆã‚‹é–¢æ•°å‚ç…§ã«å¤‰æ›´
- [ ] å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ

#### ãƒ•ã‚§ãƒ¼ã‚º 3: inline script ã®å¤–éƒ¨åŒ– (æ¨å®š: 1-2é€±é–“)
- [ ] è¨­å®šå€¤ã‚’ JSON API ã¾ãŸã¯ dataå±æ€§çµŒç”±ã§æä¾›
- [ ] CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ meta ã‚¿ã‚°çµŒç”±ã§æä¾›
- [ ] Worker shim ã®å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«åŒ–
- [ ] å„ãƒšãƒ¼ã‚¸ã®å‹•ä½œç¢ºèª

#### ãƒ•ã‚§ãƒ¼ã‚º 4: nonce ãƒ™ãƒ¼ã‚¹ CSP ã®å°å…¥ (æ¨å®š: 1é€±é–“)
- [ ] SecurityHeaders ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å®Ÿè£…
- [ ] nonce ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…
- [ ] æ®‹å­˜ã™ã‚‹ inline script ã¸ã® nonce ä»˜ä¸
- [ ] ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼

#### ãƒ•ã‚§ãƒ¼ã‚º 5: inline style ã®å¯¾å¿œ (æ¨å®š: 1-2é€±é–“)
- [ ] CSS ã‚¯ãƒ©ã‚¹ã¸ã®ç§»è¡Œ
- [ ] å‹•çš„ã‚¹ã‚¿ã‚¤ãƒ«ã®å¤–éƒ¨ CSS ãƒ•ã‚¡ã‚¤ãƒ«åŒ–
- [ ] style-src ã§ã® nonce å¯¾å¿œ

#### ãƒ•ã‚§ãƒ¼ã‚º 6: æ®µéšçš„ãªãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ (æ¨å®š: 2-3é€±é–“)
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ
- [ ] report-only ãƒ¢ãƒ¼ãƒ‰ã§ã®æœ¬ç•ªç›£è¦–
- [ ] æ®µéšçš„ãª enforce ãƒ¢ãƒ¼ãƒ‰ã¸ã®ç§»è¡Œ
- [ ] ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨èª¿æ•´

### 4.2 ãƒªã‚¹ã‚¯ç®¡ç†

| ãƒªã‚¹ã‚¯ | å½±éŸ¿ | å¯¾ç­– |
|--------|------|------|
| æ—¢å­˜æ©Ÿèƒ½ã®ç ´æ | é«˜ | æ®µéšçš„ç§»è¡Œã€ååˆ†ãªãƒ†ã‚¹ãƒˆ |
| ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ | ä¸­ | nonce ã¯ä¸»è¦ãƒ–ãƒ©ã‚¦ã‚¶ã§å¯¾å¿œæ¸ˆã¿ |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ | ä½ | nonce ç”Ÿæˆã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã¯æœ€å°é™ |
| é–‹ç™ºé€Ÿåº¦ã®ä½ä¸‹ | ä¸­ | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™ã€ãƒ„ãƒ¼ãƒ«å°å…¥ |

---

## 5. æŠ€è¡“è¨­è¨ˆ

### 5.1 nonce ãƒ™ãƒ¼ã‚¹ CSP ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `src/Security/CspMiddleware.php`

```php
<?php
namespace App\Security;

class CspMiddleware
{
    private string $nonce;
    
    public function __construct()
    {
        $this->nonce = base64_encode(random_bytes(16));
    }
    
    public function getNonce(): string
    {
        return $this->nonce;
    }
    
    public function sendCspHeader(bool $isAdmin = false, bool $reportOnly = false): void
    {
        $nonce = $this->nonce;
        
        if ($isAdmin) {
            $csp = "default-src 'self'; " .
                   "script-src 'self' 'nonce-{$nonce}' cdn.jsdelivr.net code.jquery.com; " .
                   "style-src 'self' 'nonce-{$nonce}' cdn.jsdelivr.net fonts.googleapis.com; " .
                   "img-src 'self' data: blob: https:; " .
                   "font-src 'self' fonts.gstatic.com cdn.jsdelivr.net; " .
                   "connect-src 'self'";
        } else {
            $csp = "default-src 'self'; " .
                   "script-src 'self' 'nonce-{$nonce}' cdn.jsdelivr.net code.jquery.com; " .
                   "style-src 'self' 'nonce-{$nonce}' cdn.jsdelivr.net fonts.googleapis.com; " .
                   "img-src 'self' data: blob:; " .
                   "font-src 'self' fonts.gstatic.com; " .
                   "connect-src 'self'";
        }
        
        $headerName = $reportOnly ? 'Content-Security-Policy-Report-Only' : 'Content-Security-Policy';
        header($headerName . ': ' . $csp);
    }
}
```

### 5.2 inline script ã®å¤–éƒ¨åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³

#### ãƒ‘ã‚¿ãƒ¼ãƒ³ A: dataå±æ€§ + å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

**å¤‰æ›´å‰**:
```html
<script>
    const ADMIN_PATH = '<?= PathHelper::getAdminPath() ?>';
</script>
```

**å¤‰æ›´å¾Œ**:
```html
<body data-admin-path="<?= escapeHtml(PathHelper::getAdminPath()) ?>">
```

```javascript
// admin.js
const ADMIN_PATH = document.body.dataset.adminPath;
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³ B: meta ã‚¿ã‚°

**å¤‰æ›´å‰**:
```html
<script>
    window.CSRF_TOKEN = '<?= $csrfToken ?>';
</script>
```

**å¤‰æ›´å¾Œ**:
```html
<meta name="csrf-token" content="<?= escapeHtml($csrfToken) ?>">
```

```javascript
// admin.js
const CSRF_TOKEN = document.querySelector('meta[name="csrf-token"]').content;
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³ C: JSON API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

å¤§é‡ã®è¨­å®šå€¤ã‚„ãƒ‡ãƒ¼ã‚¿ã®å ´åˆ:

```javascript
// config.js
fetch('/api/config.php')
    .then(response => response.json())
    .then(config => {
        window.APP_CONFIG = config;
    });
```

### 5.3 eval() ã®ä»£æ›¿å®Ÿè£…

**å¤‰æ›´å‰**:
```javascript
const fn = (typeof eval(name) === 'function') ? eval(name) : null;
```

**å¤‰æ›´å¾Œ**:
```javascript
const functionMap = {
    'loadPosts': loadPosts,
    'loadThemeSettings': loadThemeSettings,
    'loadSettings': loadSettings,
    // ... ä»–ã®é–¢æ•°
};

const fn = functionMap[name] || null;
```

---

## 6. å®Ÿè£…å„ªå…ˆåº¦

### 6.1 é«˜å„ªå…ˆåº¦ï¼ˆã™ãã«å¯¾å¿œã™ã¹ãï¼‰

1. **eval() ã®å»ƒæ­¢** (public/admin/js/admin.js:565)
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯: ä¸­
   - å®Ÿè£…é›£æ˜“åº¦: ä½
   - å½±éŸ¿ç¯„å›²: ç®¡ç†ç”»é¢ã®ã¿

2. **è¨­å®šå€¤ã®å¤–éƒ¨åŒ–** (å…¨ãƒšãƒ¼ã‚¸ã® inline script)
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯: é«˜
   - å®Ÿè£…é›£æ˜“åº¦: ä½
   - å½±éŸ¿ç¯„å›²: å…¨ãƒšãƒ¼ã‚¸

### 6.2 ä¸­å„ªå…ˆåº¦ï¼ˆè¨ˆç”»çš„ã«å¯¾å¿œï¼‰

3. **Worker constructor shim ã®å¤–éƒ¨åŒ–** (paint/index.php:534-560)
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯: ä¸­
   - å®Ÿè£…é›£æ˜“åº¦: ä¸­
   - å½±éŸ¿ç¯„å›²: ãƒšã‚¤ãƒ³ãƒˆæ©Ÿèƒ½ã®ã¿

4. **nonce ãƒ™ãƒ¼ã‚¹ CSP ã®å°å…¥**
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯: é«˜ï¼ˆå¯¾ç­–ã¨ã—ã¦ï¼‰
   - å®Ÿè£…é›£æ˜“åº¦: ä¸­
   - å½±éŸ¿ç¯„å›²: å…¨ä½“

### 6.3 ä½å„ªå…ˆåº¦ï¼ˆé•·æœŸçš„ãªæ”¹å–„ï¼‰

5. **inline style ã®å¤–éƒ¨åŒ–**
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯: ä½
   - å®Ÿè£…é›£æ˜“åº¦: é«˜ï¼ˆæ•°ãŒå¤šã„ï¼‰
   - å½±éŸ¿ç¯„å›²: å…¨ãƒšãƒ¼ã‚¸

6. **å¤–éƒ¨CDNã®SRIå¯¾å¿œ**
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯: ä¸­
   - å®Ÿè£…é›£æ˜“åº¦: ä½
   - å½±éŸ¿ç¯„å›²: CDNä½¿ç”¨ç®‡æ‰€

---

## 7. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 7.1 ãƒ†ã‚¹ãƒˆç’°å¢ƒ

- **é–‹ç™ºç’°å¢ƒ**: CSP report-only ãƒ¢ãƒ¼ãƒ‰ã§ç›£è¦–
- **ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ**: CSP enforce ãƒ¢ãƒ¼ãƒ‰ã§æ¤œè¨¼
- **æœ¬ç•ªç’°å¢ƒ**: æ®µéšçš„ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ

### 7.2 ãƒ†ã‚¹ãƒˆé …ç›®

#### æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
- [ ] ç®¡ç†ç”»é¢ã®å…¨æ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹ã“ã¨
- [ ] æŠ•ç¨¿ã®ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤
- [ ] ãƒ†ãƒ¼ãƒè¨­å®šã®å¤‰æ›´
- [ ] ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- [ ] ãƒšã‚¤ãƒ³ãƒˆæ©Ÿèƒ½
- [ ] ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
- [ ] inline script ãŒå®Ÿè¡Œã•ã‚Œãªã„ã“ã¨ï¼ˆCSP enforce ãƒ¢ãƒ¼ãƒ‰ï¼‰
- [ ] eval() ãŒå®Ÿè¡Œã•ã‚Œãªã„ã“ã¨
- [ ] å¤–éƒ¨ã‹ã‚‰ã® script æ³¨å…¥ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã“ã¨
- [ ] CSP violation ãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª

#### ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ãƒ†ã‚¹ãƒˆ
- [ ] Chrome/Edge (æœ€æ–°ç‰ˆ)
- [ ] Firefox (æœ€æ–°ç‰ˆ)
- [ ] Safari (æœ€æ–°ç‰ˆ)
- [ ] ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶

### 7.3 CSP Violation ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

```php
// config/config.default.php ã«è¿½åŠ 
'csp' => [
    'enabled' => true,
    'report_only' => true,  // åˆæœŸã¯ãƒ¬ãƒãƒ¼ãƒˆã®ã¿
    'report_uri' => '/api/csp-report',  // violation ãƒ¬ãƒãƒ¼ãƒˆå…ˆ
],
```

---

## 8. ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆè¨ˆç”»

### 8.1 æ®µéšçš„ãªç§»è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

| ãƒ•ã‚§ãƒ¼ã‚º | æœŸé–“ | å†…å®¹ | CSPãƒ¢ãƒ¼ãƒ‰ |
|---------|------|------|----------|
| Phase 0 | Week 0 | ç¾çŠ¶åˆ†æãƒ»è¨ˆç”»ç­–å®š | - |
| Phase 1 | Week 1-2 | eval() å»ƒæ­¢ + è¨­å®šå€¤å¤–éƒ¨åŒ– | report-only (dev) |
| Phase 2 | Week 3-4 | nonce ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£… | report-only (staging) |
| Phase 3 | Week 5-6 | Worker shim å¤–éƒ¨åŒ– | report-only (staging) |
| Phase 4 | Week 7-8 | çµ±åˆãƒ†ã‚¹ãƒˆãƒ»ãƒã‚°ä¿®æ­£ | report-only (staging) |
| Phase 5 | Week 9-10 | æœ¬ç•ªç’°å¢ƒ report-only ç›£è¦– | report-only (prod) |
| Phase 6 | Week 11-12 | æœ¬ç•ªç’°å¢ƒ enforce ãƒ¢ãƒ¼ãƒ‰ | enforce (prod) |

### 8.2 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

å„ãƒ•ã‚§ãƒ¼ã‚ºã§å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆï¼š

1. **å³åº§ã« report-only ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™** (config å¤‰æ›´ã®ã¿)
2. **å•é¡Œã®åŸå› ã‚’ç‰¹å®š**ï¼ˆCSP violation ãƒ¬ãƒãƒ¼ãƒˆåˆ†æï¼‰
3. **ä¿®æ­£å¾Œã€å†åº¦ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ**

```php
// ç·Šæ€¥æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
'csp' => [
    'enabled' => false,  // CSPã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
],
```

---

## 9. æˆåŠŸåŸºæº–

### 9.1 æŠ€è¡“çš„ãªæˆåŠŸåŸºæº–

- [ ] `'unsafe-inline'` ã®å®Œå…¨å»ƒæ­¢ï¼ˆscript-src, style-srcï¼‰
- [ ] `'unsafe-eval'` ã®å®Œå…¨å»ƒæ­¢
- [ ] CSP violation ãƒ¬ãƒãƒ¼ãƒˆä»¶æ•° 0
- [ ] å…¨æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆåˆæ ¼
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ < 5%

### 9.2 é‹ç”¨çš„ãªæˆåŠŸåŸºæº–

- [ ] æœ¬ç•ªç’°å¢ƒã§ 1é€±é–“å•é¡Œãªãç¨¼åƒ
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å•é¡Œå ±å‘Šãªã—
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã§ã®è­¦å‘Šè§£æ¶ˆ

---

## 10. å‚è€ƒè³‡æ–™

### 10.1 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `docs/SECURITY_REVIEW.md` - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼å ±å‘Šæ›¸
- `design/IMPLEMENTATION_STATUS.md` - å®Ÿè£…çŠ¶æ³
- [MDN: Content Security Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)
- [CSP Evaluator](https://csp-evaluator.withgoogle.com/)

### 10.2 é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| `src/Security/SecurityUtil.php` | ç¾åœ¨ã® CSP å®Ÿè£… |
| `config/config.default.php` | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š |
| `public/admin/index.php` | ç®¡ç†ç”»é¢ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ |
| `public/admin/paint/index.php` | ãƒšã‚¤ãƒ³ãƒˆæ©Ÿèƒ½ãƒšãƒ¼ã‚¸ |
| `public/admin/js/admin.js` | ç®¡ç†ç”»é¢ JavaScript |

---

## 11. æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### 11.1 å³åº§ã«å®Ÿæ–½ã™ã¹ãé …ç›®

1. **ã“ã®ç§»è¡Œè¨ˆç”»ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼**
   - ãƒãƒ¼ãƒ å†…ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ‰¿èª
   - å¿…è¦ã«å¿œã˜ã¦è¨ˆç”»ã®èª¿æ•´

2. **é–‹ç™ºç’°å¢ƒã§ã®äºˆå‚™èª¿æŸ»**
   - CSP report-only ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
   - violation ãƒ¬ãƒãƒ¼ãƒˆã®åé›†ãƒ»åˆ†æ

3. **Issue ã®æ›´æ–°**
   - æœ¬ç§»è¡Œè¨ˆç”»ã‚’ Issue ã«ãƒªãƒ³ã‚¯
   - å„ãƒ•ã‚§ãƒ¼ã‚ºã‚’å€‹åˆ¥ã® Issue/PR ã«åˆ†å‰²

### 11.2 æ¨å¥¨ã•ã‚Œã‚‹è¿½åŠ èª¿æŸ»

- [ ] ç¬¬ä¸‰è€…ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆBootstrap, jQueryï¼‰ã® CSP äº’æ›æ€§ç¢ºèª
- [ ] ä»–ã®PHPã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã® CSP ç§»è¡Œäº‹ä¾‹ã®èª¿æŸ»
- [ ] nonce ãƒ™ãƒ¼ã‚¹ CSP ã®è‡ªå‹•ãƒ†ã‚¹ãƒˆæ–¹æ³•ã®æ¤œè¨

---

## 12. çµè«–

### 12.1 ç§»è¡Œã®å¿…è¦æ€§

**ã“ã®ç§»è¡Œã¯å®Ÿæ–½ã™ã¹ãã§ã™ã€‚ç†ç”±ï¼š**

1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Š**: XSS æ”»æ’ƒãƒªã‚¹ã‚¯ã®å¤§å¹…ãªè»½æ¸›
2. **ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹**: ç¾ä»£çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¨™æº–ã«æº–æ‹ 
3. **å®Ÿç¾å¯èƒ½æ€§**: æŠ€è¡“çš„ã«å®Ÿç¾å¯èƒ½ã§ã€æ®µéšçš„ãªç§»è¡ŒãŒå¯èƒ½

### 12.2 æ¨å¥¨ã•ã‚Œã‚‹é€²ã‚æ–¹

1. **çŸ­æœŸï¼ˆ1-2ãƒ¶æœˆï¼‰**: eval() å»ƒæ­¢ + è¨­å®šå€¤å¤–éƒ¨åŒ–ï¼ˆé«˜å„ªå…ˆåº¦é …ç›®ï¼‰
2. **ä¸­æœŸï¼ˆ3-4ãƒ¶æœˆï¼‰**: nonce ãƒ™ãƒ¼ã‚¹ CSP ã®å®Œå…¨å°å…¥
3. **é•·æœŸï¼ˆ6ãƒ¶æœˆä»¥ä¸Šï¼‰**: inline style ã®å¤–éƒ¨åŒ–ã€SRI å¯¾å¿œ

### 12.3 ãƒªã‚¹ã‚¯è©•ä¾¡

**ç·åˆãƒªã‚¹ã‚¯**: ğŸŸ¢ ä½ã€œä¸­

- æ®µéšçš„ãªç§»è¡Œã«ã‚ˆã‚Šã€ãƒªã‚¹ã‚¯ã‚’æœ€å°åŒ–ã§ãã‚‹
- report-only ãƒ¢ãƒ¼ãƒ‰ã§ã®ååˆ†ãªæ¤œè¨¼ãŒå¯èƒ½
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹æ®µãŒç¢ºç«‹ã•ã‚Œã¦ã„ã‚‹

---

**ã“ã®ç§»è¡Œè¨ˆç”»ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šã®ãŸã‚ã«æ¨å¥¨ã•ã‚Œã¾ã™ã€‚**  
**åˆ¥ Issue/PR ã§æ®µéšçš„ã«å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’ææ¡ˆã—ã¾ã™ã€‚**
