# お絵描き機能セキュリティ設計

## 認証・認可

### セッション管理
- **継承**: 既存の `public/admin/` セッション管理を完全継承
- **確認**: 各APIリクエストでセッション有効性を確認
- **タイムアウト**: 既存のセッションタイムアウト設定を適用 (デフォルト: 2時間)
- **再生成**: 重要な操作 (保存/削除) 時にセッションIDを再生成

### 権限管理
- **アクセス制御**: admin権限を持つユーザーのみアクセス可能
- **リソース所有権**: 作品は作成者のみ編集/削除可能
- **公開作品**: 一般公開作品は閲覧のみ許可

## CSRF対策

### トークン管理
- **生成**: ページ読み込み時にCSRFトークンを生成
- **埋め込み**: フォームとAJAXリクエストにトークンを含める
- **検証**: サーバー側でトークンの有効性を確認
- **有効期限**: トークンは1時間で有効期限切れ

### 実装例
```php
// トークン生成
$csrfToken = CsrfProtection::generateToken();

// 検証
if (!CsrfProtection::validateToken($_POST['csrf_token'])) {
    throw new SecurityException('CSRF token invalid');
}
```

## ファイルアップロードセキュリティ

### ファイルタイプ検証
 **許可拡張子**: `.png`, `.jpg`, `.jpeg`, `.csv.gz`
- **MIMEタイプ確認**: `image/png`, `image/jpeg`, `application/octet-stream`
 **許可拡張子**: `.png`, `.jpg`, `.jpeg`, `.webp`, `.csv.gz`
- **拡張子検査**: 二重拡張子や危険な拡張子を拒否
 タイムラプス の処理には zlib（gzip 圧縮の対応）と CSV パーサのサポートが必要です。サーバ側では gzdecode を使って展開し、ヘッダ付き CSV を安全に解析してください。
### 更新: WebP対応
- **許可拡張子**: `.png`, `.jpg`, `.jpeg`, `.webp`, `.csv.gz`
- **MIMEタイプ確認**: `image/png`, `image/jpeg`, `image/webp`, `application/octet-stream`
- **コンテンツ検証（強化）**:
    - `finfo_file()` / `Fileinfo` を使って実際の MIME を検証する。
    - 画像はヘッダー（シグネチャ）を確認して拡張子と一致することを確認する。
    - 二重拡張子（例: `file.png.php`）や不正なパス文字列は拒否する。
    - WebP については `RIFF`/`WEBP` シグネチャの検査を行う。

### サムネイル生成とライブラリ要件
- サムネイルは WebP 出力を推奨。サーバ側で WebP に変換するために `gd`（WebP対応）または `imagick` を使用する。どちらも無ければ変換を拒否してエラーを返す。
 - タイムラプス (.csv.gz) の処理には zlib（gzip 圧縮の対応）とヘッダ付き CSV を安全に解析するための処理が必要です。サーバ側では gzdecode を使って展開し、`str_getcsv` や堅牢なCSVパーサで解析してください。

### サイズ制限
- **画像ファイル**: 最大10MB
- **タイムラプス**: 最大50MB (設定可能)
- **一時ファイル**: 最大5MB
- **分割アップロード**: 大きいファイルをチャンクに分割してアップロード

### ファイル名セキュリティ
- **サニタイズ**: 危険な文字を除去 (`< > : " | ? * \ /`)
- **ランダム化**: アップロードファイル名をランダム生成
- **パス制御**: アップロード先ディレクトリを固定 (`data/illusts/`)

### ファイルアクセス制御
- **公開ファイル**: サムネイル・画像は `uploads/` 以下に配置、直接アクセス許可
- **非公開ファイル**: .illust・タイムラプスは `data/` 以下に配置、PHP経由のみ
- **PHP経由アクセス**: 非公開ファイルはPHP API経由に制限
- **所有権検証**: 非公開ファイルアクセス時にDBの所有権を確認
- **ストリーミング制御**: 大きなファイルのレンジリクエストを適切に処理
- **アクセスログ**: 非公開ファイルのダウンロードをログ記録

### 実装例
```php
// ファイル検証
$allowedTypes = ['image/png', 'image/jpeg'];
$maxSize = 10 * 1024 * 1024; // 10MB

if (!in_array($_FILES['file']['type'], $allowedTypes)) {
    throw new SecurityException('Invalid file type');
}

if ($_FILES['file']['size'] > $maxSize) {
    throw new SecurityException('File too large');
}

// 安全なファイル名生成
$safeName = bin2hex(random_bytes(16)) . '.png';
```

## XSS対策

### 入力検証
- **HTMLエスケープ**: すべてのユーザー入力をエスケープ
- **ホワイトリスト**: 許可されたHTMLタグのみ許可 (タイトル等)
- **JSONレスポンス**: APIレスポンスはJSONで安全

### 出力エスケープ
```php
// PHPでのエスケープ
echo htmlspecialchars($title, ENT_QUOTES, 'UTF-8');

// JavaScriptでのエスケープ
var title = <?= json_encode($title) ?>;
```

## SQLインジェクション対策

### パラメータ化クエリ
- **PDO使用**: すべてのクエリでプリペアドステートメントを使用
- **型チェック**: バインドパラメータの型を明示的に指定
- **ホワイトリスト**: 動的テーブル名やカラム名はホワイトリストで検証

### 実装例
```php
$stmt = $pdo->prepare("SELECT * FROM illusts WHERE id = ? AND user_id = ?");
$stmt->execute([$illustId, $userId]);
```

## ディレクトリトラバーサル対策

### パス制御
- **絶対パス使用**: ファイル操作は常に絶対パスを使用
- **ベースパス制限**: アップロード先を `uploads/` 以下に制限
- **パス正規化**: `realpath()` でシンボリックリンクを解決
- **親ディレクトリチェック**: `../` を含むパスを拒否

### 実装例
```php
$baseDir = '/home/claudecode/photo-site/uploads/illusts/';
$requestedPath = $_GET['path'];

$realPath = realpath($baseDir . $requestedPath);
if (strpos($realPath, $baseDir) !== 0) {
    throw new SecurityException('Invalid path');
}
```

## レート制限

### API制限
- **保存操作**: 1分間に5回
- **読み込み操作**: 1分間に30回
- **一覧取得**: 1分間に10回
- **ファイルアップロード**: 1分間に3回

### 実装
- **RateLimiterクラス使用**: 既存のRateLimiterを継承
- **ユーザー別制限**: IPアドレス + ユーザーIDで制限
- **指数バックオフ**: 制限超過時は待機時間を増やす

## データ検証

### 入力バリデーション
- **キャンバスサイズ**: 1-4096px の範囲
- **レイヤー数**: 固定4レイヤー
- **色値**: 有効なHEX色コード
- **座標値**: キャンバス範囲内

### ビジネスロジック検証
- **所有権確認**: 作品編集時に所有者確認
- **状態遷移**: 下書き→公開 のみ許可
- **容量チェック**: タイムラプス容量上限確認

## エラーハンドリング

### 安全なエラー表示
- **一般ユーザー**: 詳細なエラーメッセージを隠す
- **管理者**: ログに詳細を記録
- **ログ記録**: セキュリティイベントを別途ログ

### 実装例
```php
try {
    // 危険な操作
} catch (SecurityException $e) {
    error_log("Security violation: " . $e->getMessage());
    http_response_code(403);
    echo json_encode(['error' => 'Access denied']);
}
```

## 監査ログ

### ログ内容
- **操作履歴**: 保存/削除/公開 操作のログ
- **ファイル操作**: アップロード/ダウンロードのログ
- **認証失敗**: ログイン失敗のログ
- **異常アクセス**: 不審なリクエストのログ

### ログ形式
```
[2024-01-01 12:00:00] [user:123] [action:save_illust] [illust:456] [ip:192.168.1.1]
```

## バックアップとリカバリ

### データバックアップ
- **定期バックアップ**: 作品データとタイムラプスを定期バックアップ
- **暗号化**: バックアップデータを暗号化
- **検証**: バックアップの完全性を定期的に検証

### インシデント対応
- **隔離**: セキュリティインシデント時はシステムを隔離
- **フォレンジック**: ログを保持して調査
- **通知**: 管理者への緊急通知

## 依存関係のセキュリティ

### ライブラリ管理
- **Composer**: 依存ライブラリをComposerで管理
- **脆弱性スキャン**: 定期的に依存ライブラリの脆弱性をスキャン
- **更新**: セキュリティパッチを迅速に適用

### 外部サービス
- **最小権限**: 外部API使用時は最小権限のAPIキー
- **暗号化**: 通信はHTTPSのみ
- **監視**: 外部サービスへの異常アクセスを監視

## テストと検証

### セキュリティテスト
- **ペネトレーションテスト**: 定期的なセキュリティテスト
- **自動化テスト**: SQLインジェクション、XSS等の自動テスト
- **コードレビュー**: セキュリティ関連コードのレビュー

### 継続的監視
- **ログ監視**: 不審なパターンを検知
- **アラート**: セキュリティイベントのアラート
- **レポート**: 月次セキュリティレポート