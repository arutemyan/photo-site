# セキュリティコードレビュー報告書

**レビュー日**: 2025-11-15  
**対象**: pixugallery アプリケーション  
**レビュー範囲**: SQLインジェクション、CORS、XSS、セッション管理、CSRF、認証・認可、その他のセキュリティ関連コード

---

## 要点（未対応項目を先頭にまとめ、対応済みは概要のみ）

以下は本レビュー時点で「未対応」「今後対応予定」または「注意が必要」と判断した項目です。対応済みの項目はこの後に簡潔にまとめています。

### 未対応／対応中（優先度順）

（現在の主要な未対応項目は以下の通りです。CSP に関してはサーバ側での nonce 発行およびテンプレート側の nonce 埋め込みが実装済みのため、運用確認フェーズに移行しています — 対応済み欄を参照ください）

- ビルド済みバンドル内のインラインスタイル/スクリプトの除去（中）
   - 目的: 実運用で CSP を厳格化可能にするため
   - 現状: ソース側でインライン化を取り除く対応は進行中だが、ビルド再実行が必要
   - 次アクション: フロントエンドビルド手順の確認、CI における CSP チェック追加

- 運用上のディレクトリ権限と秘密鍵管理のレビュー（中）
   - 目的: `session_keys/` 等のディレクトリ権限が一貫して安全であることを保証する
   - 現状: 一部ディレクトリでパーミッションが緩い可能性が報告されている（例: 既存ディレクトリのパーミッション確認不足）
   - 次アクション: ディレクトリ分類（public/protected/private）に基づく権限ポリシーを適用し、運用ドキュメントに手順を明記

- ビルド済みバンドル内のインラインスタイル/スクリプトの除去（中）
   - 目的: 実運用で CSP を厳格化可能にするため
   - 現状: ソース側でインライン化を取り除く対応は進行中だが、ビルド再実行が必要
   - 次アクション: フロントエンドビルド手順の確認、CI における CSP チェック追加

- 運用上のディレクトリ権限と秘密鍵管理のレビュー（中）
   - 目的: `session_keys/` 等のディレクトリ権限が一貫して安全であることを保証する
   - 現状: 一部ディレクトリでパーミッションが緩い可能性が報告されている（例: 既存ディレクトリのパーミッション確認不足）
   - 次アクション: ディレクトリ分類（public/protected/private）に基づく権限ポリシーを適用し、運用ドキュメントに手順を明記

※ 上記は『未対応』と見なす項目の一覧です。続く「対応済み（概要）」では、既にコード上で修正した項目を短くまとめています。



---

## 対応済み（概要）

以下はコードベース上で修正または対処済みの主要項目です。詳細な説明はリポジトリの該当コミットや差分を参照してください。

- PostgreSQL スキーマ設定に関する潜在的な SQLインジェクション：スキーマ名検証を追加し、補間のリスクを排除（修正済み）
- セッション設定：`force_secure_cookie` オプションの追加とセッションに関する設定強化（修正済み）
- CORS 設定：許容オリジンの設定追加と動的オリジン検証の実装（修正済み）
- CSRF / XSS 対策：`CsrfProtection` と `escapeHtml()` 等により主要な対策を確認（実装済み）
- ファイルアップロード検証：MIME/拡張子/サイズ検証とパストラバーサル対策（実装済み）
- 入力検証の強化：タグ検索等の軽微な入力検証追加（修正済み）
- レート制限：ログイン・API の基本的な制限が適用（実装済み）

- CSP（Content-Security-Policy）: nonce ベース導入（実装済み、運用確認中）
   - 概要: サーバ側に `CspMiddleware` を実装し、リクエスト単位で nonce を生成して CSP ヘッダーを送信する仕組みを導入しました。テンプレートや一部のスクリプトタグは既に `nonce` 属性を付与しており、`AssetHelper::scriptTag()` でも nonce を付与する処理が実装されています。
   - 確認済み実装箇所:
      - `src/Security/CspMiddleware.php` — nonce 生成と `sendCspHeader()` 実装
      - テンプレート/エントリポイント（例: `public/*.php`）での `nonce` 埋め込み
      - `src/Utils/AssetHelper.php` — CSP 有効時に script タグへ nonce を付与するロジック
   - 残件（運用確認）:
      - CI/デプロイ環境で `security.csp.enabled` を有効化してヘッダー送信を検証すること。
      - ビルド済みバンドル内のインライン化 (inline scripts/styles) を完全に除去し、Report-Only モードでのログ収集によるランタイム確認を推奨。
      - 小さな構成差異（`sendSecurityHeaders()` が期待する設定キーの場所など）を確認し、本番設定で確実に CSP ヘッダーが送信されることを検証してください。

---

### 補足

- 本ファイルは「未対応項目を先頭に配置し、対応済み項目は概要のみ残す」方針で簡潔化しました。
- もし特定の「対応済み項目」について、運用手順や担当者・期限などの詳細を残したい場合は、該当項目だけ詳細を追記してください。

---

### 検証済みファイル（抜粋）

以下は「対応済み」として本書に記載した項目をソース／設定から確認した際に参照した主要なファイルです。詳細は各ファイルの該当箇所を確認してください。

- `src/Database/Connection.php`  — PostgreSQL スキーマ名検証と SET search_path の実装
- `src/Services/Session.php`  — `force_secure_cookie` の適用、キー管理、`ensureKeyDir()` による権限調整
- `config/config.default.php` / `config/config.local.example.php` / `README.md` — `force_secure_cookie` と CORS の設定例
- `src/Security/CspMiddleware.php` / `src/Security/SecurityUtil.php` — nonce ベース CSP のミドルウェア呼び出しと sendSecurityHeaders の実装（CSPは設定で有効化が必要）
- `src/Security/CsrfProtection.php` / `src/Controllers/AdminControllerBase.php` — CSRF トークン生成・検証の適用箇所
- `src/Security/SecurityUtil.php` — `escapeHtml()`, `finfo_file()` / `is_uploaded_file()` を使ったファイル検証ユーティリティ
- `src/Security/RateLimiter.php` / `public/api/posts.php` — RateLimiter の利用と API 側でのチェック
- `src/Models/Tag.php` / `src/Services/PostTagService.php` — タグ検索時の入力検証とパターン構築（LIKEの扱い）

これらのファイルを根拠として「対応済み（概要）」に記載しています。未対応項目については本稿先頭の一覧を優先してください。

## 追加検証結果（2025-11-15）

- 実施内容: ビルド済みフロントエンドバンドル（`*.bundle.js`）の検出と静的スキャンを実行しました。スキャン対象はリポジトリ内に存在するバンドルファイルです。
- スキャン対象ファイル（ワークツリー上）:
   - `public/admin/js/admin.bundle.js`
   - `public/admin/js/sns-share.bundle.js`
   - `public/admin/paint/js/paint.bundle.js`
   - `public/paint/js/detail.bundle.js`
   - `public/paint/js/gallery.bundle.js`
   - `public/paint/js/timelapse_player.bundle.js`
   - `public/res/js/detail.bundle.js`
   - `public/res/js/main.bundle.js`
- 検査内容: `unsafe-inline` / `unsafe-eval` / `eval(` / `new Function` / 明示的なインライン `<script>` タグ等の痕跡を検索
- 結果: 上記バンドル内に該当する危険なパターンは検出されませんでした（静的grepによる検出での結果）。

- 注意事項: 本検査は静的文字列検索による一次スキャンです。バンドル内部で動的に生成されるコードや実行時に組み立てられる文字列は検出対象外です。完全性を高めるにはビルド後のランタイム挙動の監視（Report-Only モードでの CSP ログ収集）を推奨します。

- `docs/work` の扱い: 本スキャン結果を受け、作業用の `docs/work` ディレクトリはワークツリーから削除しました。削除はリポジトリのコミット履歴に残るため、必要であれば履歴から復元できます。


### 作成したドキュメント

1. **SECURITY.md** - 包括的なセキュリティガイド
   - すべてのセキュリティ機能の説明
   - 実装例とベストプラクティス
   - 本番環境での推奨設定
   - セキュリティチェックリスト

2. **SECURITY_REVIEW.md** (本文書)
   - レビュー結果の詳細
   - 発見された問題と修正内容
   - 推奨事項

---

## 推奨事項

### 即座に実施すべき項目

1. **本番環境での設定**:
   - [ ] `force_secure_cookie` を `true` に設定
   - [ ] CORS の `allowed_origins` を具体的なドメインに変更
   - [ ] HTTPS を強制し、HSTS を有効化
   - [ ] 管理画面のパスを推測されにくい名前に変更

2. **ファイルパーミッション**:
   - [ ] データベースファイルを 600 に設定
   - [ ] 設定ファイルを 600 に設定
   - [ ] セッションキーディレクトリを 700 に設定

### 中期的な改善項目

1. **CSP の強化**:
   - nonce または hash ベースの CSP に移行
   - inline JavaScript の削除
   - `unsafe-eval` の削除

2. **セキュリティ機能の追加**:
   - 二要素認証（2FA）の実装
   - ログイン通知機能
   - IP ホワイトリスト機能（管理画面）

3. **監視とアラート**:
   - セキュリティイベントの自動アラート
   - 異常なアクセスパターンの検出
   - 定期的なセキュリティログの分析

### 長期的な改善項目

1. **セキュリティ監査**:
   - 定期的な外部セキュリティ監査
   - ペネトレーションテスト
   - 脆弱性スキャン

2. **セキュリティトレーニング**:
   - 開発チームへのセキュアコーディング研修
   - セキュリティベストプラクティスの共有

---

## 結論

pixugallery アプリケーションは主要なセキュリティ実装が適切に行われており、重大な脆弱性は対処済みです。ただし運用設定（CORS の厳格化、セッションクッキーの強制、HSTS の適用等）や CSP の強化は、デプロイ前に必ず適用してください。

CSP については段階的な移行計画が進行中で、移行計画に従って管理画面→一般ページの順に `unsafe-*` 指定の除去を実施することを推奨します。

本レビューは運用上のチェックリストと合わせて反映してください。

**最終評価**: 良好（推奨設定適用と CSP 移行の完了でさらに評価が上がります）

---

**レビュー担当**: セキュリティレビュー チーム  
**レビュー完了日**: 2025-11-15
