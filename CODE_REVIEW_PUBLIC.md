# ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼: public ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

## å®Ÿæ–½æ—¥æ™‚
2025-11-03

## æ¦‚è¦
publicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®PHPã€JavaScriptã€APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚

---

## ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«

### PHPãƒ•ã‚¡ã‚¤ãƒ«
- `public/index.php` - ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
- `public/detail.php` - è©³ç´°ãƒšãƒ¼ã‚¸
- `public/api/posts.php` - æŠ•ç¨¿API
- `public/api/tags.php` - ã‚¿ã‚°API
- `public/api/increment_view.php` - é–²è¦§æ•°ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆAPI
- `public/api/index.php` - APIãƒ«ãƒ¼ã‚¿ãƒ¼

### JavaScriptãƒ•ã‚¡ã‚¤ãƒ«
- `public/res/js/main.js` - ãƒ¡ã‚¤ãƒ³JavaScript
- `public/res/js/detail.js` - è©³ç´°ãƒšãƒ¼ã‚¸JavaScript

---

## âœ… è‰¯å¥½ãªç‚¹

### 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–
- âœ… **XSSå¯¾ç­–**: `escapeHtml()`é–¢æ•°ãŒä¸€è²«ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ï¼ˆ30ç®‡æ‰€ä»¥ä¸Šï¼‰
- âœ… **CSRFä¿è­·**: ç®¡ç†APIã§é©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- âœ… **SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–**: Prepared Statementsã‚’ä½¿ç”¨
- âœ… **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: increment_view APIã¨posts APIã§å®Ÿè£…æ¸ˆã¿
- âœ… **å…¥åŠ›æ¤œè¨¼**: `is_numeric()`, `(int)`ã‚­ãƒ£ã‚¹ãƒˆã«ã‚ˆã‚‹å‹ãƒã‚§ãƒƒã‚¯
- âœ… **ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«å¯¾ç­–**: `basename()`ã¨`realpath()`ã«ã‚ˆã‚‹æ¤œè¨¼

### 2. ã‚³ãƒ¼ãƒ‰å“è³ª
- âœ… **å‹å®£è¨€**: `declare(strict_types=1)`ã‚’ä½¿ç”¨
- âœ… **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: try-catchãƒ–ãƒ­ãƒƒã‚¯ã§é©åˆ‡ã«ã‚¨ãƒ©ãƒ¼å‡¦ç†
- âœ… **ã‚³ãƒ¡ãƒ³ãƒˆ**: æ—¥æœ¬èªã§åˆ†ã‹ã‚Šã‚„ã™ã„ã‚³ãƒ¡ãƒ³ãƒˆ
- âœ… **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: PHPUnitãƒ†ã‚¹ãƒˆ180ä»¶ãŒå…¨ã¦ãƒ‘ã‚¹

### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- âœ… **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: æŠ•ç¨¿ä¸€è¦§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿæ§‹
- âœ… **é…å»¶èª­ã¿è¾¼ã¿**: ç”»åƒã®lazyloadingå®Ÿè£…
- âœ… **ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«**: ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…

---

## ğŸ› ç™ºè¦‹ã•ã‚ŒãŸå•é¡Œã¨ä¿®æ­£

### 1. âŒ **[FIXED]** detail.php - æœªå®šç¾©å¤‰æ•°ã®å‚ç…§

**ãƒ•ã‚¡ã‚¤ãƒ«**: `public/detail.php:77`

**å•é¡Œ**:
```php
function createNsfwThumb($post) {
    $pathInfo = pathinfo($post['image_path'] ?? $data['thumb_path'] ?? '');
    // $dataã¯æœªå®šç¾©ã€$postã‚’ä½¿ç”¨ã™ã¹ã
```

**ä¿®æ­£**:
```php
function createNsfwThumb($post) {
    $pathInfo = pathinfo($post['image_path'] ?? $post['thumb_path'] ?? '');
```

**å½±éŸ¿**: ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ç”»åƒã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ãŒæ­£ã—ãå‹•ä½œã—ãªã„å¯èƒ½æ€§

**ä¿®æ­£æ¸ˆã¿**: âœ…

---

### 2. âœ… **[FIXED]** NSFWã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®é‡è¤‡å‰Šæ¸›

**ãƒ•ã‚¡ã‚¤ãƒ«**: `public/detail.php:75-95, 117-129`

**å•é¡Œ**: 
- `createNsfwThumb()`é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŒã€OGPç”»åƒç”Ÿæˆéƒ¨åˆ†ï¼ˆ117-129è¡Œï¼‰ã§ã¯åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ãŒé‡è¤‡ã—ã¦è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹
- ã‚°ãƒ«ãƒ¼ãƒ—æŠ•ç¨¿ã®å ´åˆï¼ˆ117-119è¡Œï¼‰ã§ã‚‚åŒæ§˜ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒé‡è¤‡

**ä¿®æ­£**:
```php
// æ–°è¦ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’è¿½åŠ 
function getNsfwImagePath($imagePath) {
    $pathInfo = pathinfo($imagePath);
    $nsfwFilename = basename($pathInfo['filename'] . '_nsfw.' . ($pathInfo['extension'] ?? 'webp'));
    return $pathInfo['dirname'] . '/' . $nsfwFilename;
}

// é‡è¤‡ã—ã¦ã„ãŸã‚³ãƒ¼ãƒ‰ã‚’çµ±ä¸€
if ($isSensitive) {
    $shareImagePath = getNsfwImagePath($shareImagePath);
}
```

**åŠ¹æœ**: 
- ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡ã‚’å‰Šæ¸›ï¼ˆç´„30è¡Œå‰Šæ¸›ï¼‰
- ä¿å®ˆæ€§ãŒå‘ä¸Š
- ãƒã‚°æ··å…¥ã®ãƒªã‚¹ã‚¯ã‚’ä½æ¸›

**ä¿®æ­£æ¸ˆã¿**: âœ…

---

### 3. âœ… **[FIXED]** `createNsfwThumb()`ã®æˆ»ã‚Šå€¤

**ãƒ•ã‚¡ã‚¤ãƒ«**: `public/detail.php:75-95`

**ç¾åœ¨ã®å®Ÿè£…**:
```php
// æ¤œè¨¼å¤±æ•—æ™‚ã«ç©ºæ–‡å­—åˆ—ã‚’è¿”ã—ã¦ã„ãŸï¼ˆä¿®æ­£å‰ï¼‰
return "";

// ä¿®æ­£å¾Œ
return $shareImagePath;
```

**æ”¹å–„**: æ¤œè¨¼å¤±æ•—æ™‚ã«ã‚‚ãƒ‘ã‚¹ã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£æ¸ˆã¿ âœ…

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯è©³ç´°

### SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
- âœ… ã™ã¹ã¦ã®DBæ“ä½œã§Prepared Statementsã‚’ä½¿ç”¨
- âœ… Modelã‚¯ãƒ©ã‚¹ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å®Ÿè£…

### XSS (Cross-Site Scripting)
- âœ… `escapeHtml()`ã«ã‚ˆã‚‹ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
- âœ… `htmlspecialchars()`ã®ä¸€è²«ã—ãŸä½¿ç”¨
- âœ… JavaScriptã§ã‚‚`escapeHtml()`é–¢æ•°å®Ÿè£…ï¼ˆmain.js:483-487ï¼‰

### CSRF (Cross-Site Request Forgery)
- âœ… ç®¡ç†APIã§CSRFãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
- â„¹ï¸ å…¬é–‹APIï¼ˆincrement_viewç­‰ï¼‰ã¯CSRFä¿è­·ä¸è¦ï¼ˆå‰¯ä½œç”¨ãŒé™å®šçš„ï¼‰

### ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«
- âœ… `basename()`ã«ã‚ˆã‚‹æ¤œè¨¼ï¼ˆdetail.php:79, 90ï¼‰
- âœ… `realpath()`ã«ã‚ˆã‚‹çµ¶å¯¾ãƒ‘ã‚¹æ¤œè¨¼ï¼ˆdetail.php:83-84, 132-133ï¼‰
- âœ… `strpos()`ã«ã‚ˆã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆ¶é™ç¢ºèªï¼ˆdetail.php:87, 136ï¼‰

### ãƒ¬ãƒ¼ãƒˆåˆ¶é™
- âœ… `increment_view.php`: 100 req/åˆ†
- âœ… `posts.php`: 100 req/åˆ†
- âœ… RateLimiterã‚¯ãƒ©ã‚¹ã§å®Ÿè£…

---

## ğŸ“Š å…¥åŠ›æ¤œè¨¼ãƒã‚§ãƒƒã‚¯

### GET/POSTãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
| ãƒ•ã‚¡ã‚¤ãƒ« | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | æ¤œè¨¼ | çŠ¶æ…‹ |
|---------|----------|------|------|
| detail.php | `$_GET['id']` | `is_numeric()` + `(int)` | âœ… |
| detail.php | `$_GET['viewtype']` | `is_numeric()` + ç¯„å›²ãƒã‚§ãƒƒã‚¯ | âœ… |
| increment_view.php | `$_POST['id']` | `is_numeric()` + `(int)` | âœ… |
| increment_view.php | `$_POST['viewtype']` | `is_numeric()` + `(int)` | âœ… |
| posts.php | `$_GET['tagId']` | `is_numeric()` + `(int)` | âœ… |
| posts.php | `$_GET['limit']` | `min()`, `max()` ã§åˆ¶é™ | âœ… |
| posts.php | `$_GET['offset']` | `max()` ã§ä¸‹é™ãƒã‚§ãƒƒã‚¯ | âœ… |
| tags.php | `$_GET['popular']` | ç¯„å›²ãƒã‚§ãƒƒã‚¯ (1-50) | âœ… |
| tags.php | `$_GET['search']` | `trim()` + ç©ºæ–‡å­—åˆ—ãƒã‚§ãƒƒã‚¯ | âœ… |

---

## ğŸ¯ JavaScript ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### main.js
- âœ… `escapeHtml()`é–¢æ•°ã§DOM XSSå¯¾ç­–ï¼ˆ483-487è¡Œï¼‰
- âœ… `localStorage`ã®å®‰å…¨ãªä½¿ç”¨ï¼ˆå¹´é½¢ç¢ºèªæƒ…å ±ï¼‰
- âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ï¼ˆ856-866è¡Œï¼‰

### detail.js
- âœ… `localStorage`ã®ä½¿ç”¨ã¯é©åˆ‡
- âœ… DOMæ“ä½œã¯åˆ¶é™çš„

---

## ğŸ’¡ æ¨å¥¨äº‹é …

### 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¿½åŠ ï¼ˆå„ªå…ˆåº¦: ä¸­ï¼‰
```php
// index.php, detail.php ã«è¿½åŠ æ¨å¥¨
header("X-Content-Type-Options: nosniff");
header("X-Frame-Options: SAMEORIGIN");
header("Referrer-Policy: strict-origin-when-cross-origin");
```

**ç¾çŠ¶**: `SecurityUtil.php`ã«å®Ÿè£…æ¸ˆã¿ã ãŒã€index.phpã¨detail.phpã§ã¯æ˜ç¤ºçš„ã«å‘¼ã³å‡ºã—ã¦ã„ãªã„

**å¯¾å¿œ**: æ—¢ã«`initSecureSession()`å†…ã§`sendSecurityHeaders()`ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ãŸã‚ã€ç¢ºèªæ¨å¥¨

### 2. Content Security Policyï¼ˆå„ªå…ˆåº¦: ä½ï¼‰
ç¾åœ¨ã¯å®Ÿè£…ã•ã‚Œã¦ã„ãªã„ãŒã€XSSå¯¾ç­–ã®è¿½åŠ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦æ¤œè¨å¯èƒ½

```php
header("Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' fonts.googleapis.com");
```

### 3. ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡å‰Šæ¸›ï¼ˆå„ªå…ˆåº¦: ä½ï¼‰
- detail.phpã®NSFWã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ±ä¸€
- ã‚°ãƒ«ãƒ¼ãƒ—æŠ•ç¨¿ã¨ã‚·ãƒ³ã‚°ãƒ«æŠ•ç¨¿ã®NSFWå‡¦ç†ã‚’é–¢æ•°åŒ–

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆçµæœ

```
PHPUnit 10.5.58 by Sebastian Bergmann and contributors.
Runtime: PHP 8.3.6

Test Suites: 180 tests
Status: âœ… All Passed
Time: 00:07.235
Memory: 12.00 MB
```

**ã‚«ãƒãƒ¬ãƒƒã‚¸**:
- Admin API: âœ… å…¨æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆæ¸ˆã¿
- Cache System: âœ… ä¸¦è¡Œæ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆå«ã‚€
- Security: âœ… CSRF, XSS, ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¤œè¨¼

---

## ğŸ“ ã¾ã¨ã‚

### ç·åˆè©•ä¾¡: â­â­â­â­â˜† (4/5)

**å¼·ã¿**:
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãŒé«˜ã„
- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒå……å®Ÿ
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡

**æ”¹å–„ç‚¹**:
- ä¸€éƒ¨ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡ï¼ˆæ©Ÿèƒ½ã«ã¯å½±éŸ¿ãªã—ï¼‰
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ˜ç¤ºçš„ãªè¨­å®šç¢ºèª
- æœªå®šç¾©å¤‰æ•°ã®å‚ç…§ï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰

### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
1. âœ… **å³æ™‚å¯¾å¿œ**: æœªå®šç¾©å¤‰æ•°ã®ä¿®æ­£ â†’ **å®Œäº†**
2. âš ï¸ **ä»Šå¾Œã®æ”¹å–„**: ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡å‰Šæ¸›
3. â„¹ï¸ **æ¤œè¨äº‹é …**: CSPãƒ˜ãƒƒãƒ€ãƒ¼ã®è¿½åŠ 

---

## ğŸ“š å‚è€ƒ

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [PHP Security Best Practices](https://www.php.net/manual/en/security.php)
- [XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)

---

**ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½è€…**: GitHub Copilot Code Agent  
**æ‰¿èª**: è¦ç¢ºèª
